{{
        File:     txrx.spin
        Author:   Connor Spangler
        Date:     5/9/2018
        Version:  1.0
        Description: 
                  This file contains the PASM code defining a test transmission routine
}}

CON
  ' Clock settings
  _clkmode = xtal1 + pll16x     ' Standard clock mode w/ 16x PLL
  _xinfreq = 6_500_000          ' 6.5 MHz clock for x16 = 104 MHz

  ' Game settings
  NUM_TILE_COLOR_PALETTES = 32
  NUM_SPRITE_COLOR_PALETTES = 32
  NUM_SPRITES = 64
  TILE_MAP_WIDTH = 40
  TILE_MAP_HEIGHT = 30

OBJ
  vga_tx        : "vga_tx"      ' Import graphics transmission system
  input         : "input"       ' Import input system

VAR
  ' Game resource pointers
  long  input_state_base_       ' Register in Main RAM containing state of inputs
  long  gfx_resources_base_     ' Register in Main RAM containing base of graphics resources
  long  num_tile_color_pals_    ' Register in Main RAM containing number of tile color palettes 
  long  num_sprite_color_pals_  ' Register in Main RAM containing number of sprite color palettes
  long  num_sprites_            ' Register in Main RAM containing number of sprites
  long  tile_map_size_          ' Register in Main RAM containing size of tile map

  ' TEST RESOURCE POINTERS
  long  satts[num_sprites]

PUB main | cont,temp,temps,x,y
  ' Initialize variables
  input_state_base_ := @input_states                    ' Point input state base to base of input states
  gfx_resources_base_ := @tile_color_palettes           ' Set graphics resources base to start of tile color palettes
  num_tile_color_pals_ := NUM_TILE_COLOR_PALETTES       ' Set number of tile color palettes
  num_sprite_color_pals_ := NUM_SPRITE_COLOR_PALETTES   ' Set number of tile color palettes
  num_sprites_ := NUM_SPRITES                           ' Set number of sprites in sprite attribute table
  tile_map_size_ := TILE_MAP_WIDTH * TILE_MAP_HEIGHT    ' Set size of tile map

  vga_tx.start(@gfx_resources_base_)                    ' Start graphics resource transfer routine
  input.start(@input_state_base_)                       ' Start input system

  '                                  sprite         x position       y position    color v h size
  '                             |<------------->|<--------------->|<------------->|<--->|-|-|<->|
  '                              0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0
  satts[0] :=                   %0_0_0_0_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[1] :=                   %0_0_0_0_0_0_1_0_0_0_0_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[2] :=                   %0_0_0_0_0_0_1_0_0_0_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[3] :=                   %0_0_0_0_0_0_1_0_0_0_0_0_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[4] :=                   %0_0_0_0_0_0_1_0_0_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[5] :=                   %0_0_0_0_0_0_1_0_0_0_0_1_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[6] :=                   %0_0_0_0_0_0_1_0_0_0_0_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[7] :=                   %0_0_0_0_0_0_1_0_0_0_0_1_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[8] :=                   %0_0_0_0_0_0_1_0_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[9] :=                   %0_0_0_0_0_0_1_0_0_0_1_0_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[10] :=                  %0_0_0_0_0_0_1_0_0_0_1_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[11] :=                  %0_0_0_0_0_0_1_0_0_0_1_0_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[12] :=                  %0_0_0_0_0_0_1_0_0_0_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[13] :=                  %0_0_0_0_0_0_1_0_0_0_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[14] :=                  %0_0_0_0_0_0_1_0_0_0_1_1_0_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0
  satts[15] :=                  %0_0_0_0_0_0_1_0_0_0_1_1_1_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0_0

  longmove(@sprite_atts, @satts, num_sprites)

  x := 0
  y := 0
  temp := @sprite_atts + (4*17)
  repeat num_sprites-17
    x += 6
    y += 6
    x &= %111111111
    y &= %11111111
    temps := (x << 15) | (y << 7)
    longmove(temp,@temps,1)
    temp += 4

  ' Main game loop
  repeat
    vga_tx.transmit                                     ' Transmit graphics resource data
    left_right((control_state >> 7) & %10100000)
    up_down((control_state >> 7) & %01010000)
    cont := tilt_state
    if (tilt_state & 1) == 0
      longfill(@sprite_atts, 0, num_sprites)

pri left_right(x_but) | x,dir,mir,temp
    if x_but == %10000000 OR x_but == %00100000
      longmove(@x, @sprite_atts, 1)
      temp := x & %00000000000000000111111111111011
      dir := 1 << 24
      x >>= 15
      x &= %111111111
      if x_but == %10000000
        mir := 0
        x := (x + 1) & %111111111
      if x_but == %00100000
        mir := 1 << 2
        x := (x - 1) & %111111111
      if x == 320
        x := 505
      elseif x == 504
        x := 319
      x <<= 15
      temp |= (x | mir | dir)
      longmove(@sprite_atts, @temp, 1)

pri up_down(y_but) | y,dir,mir,temp
    if y_but == %01000000 OR y_but == %00010000
      longmove(@y, @sprite_atts, 1)
      temp := y & %00000000111111111000000001110111
      dir := 0 << 24
      y >>= 7
      y &= %11111111
      if y_but == %01000000
        mir := 1 << 3
        y := (y + 1) & %11111111
      if y_but == %00010000
        mir := 0
        y := (y - 1) & %11111111
      if y == 240
        y := 249
      elseif y == 248
        y := 239
      y <<= 7
      temp |= (y | mir | dir)
      longmove(@sprite_atts, @temp, 1)

DAT
input_states
              ' Input states
control_state word      0       ' Control states
tilt_state    word      0       ' Tilt shift state

tile_color_palettes
              ' Tile color palettes
t_palette0    byte      %00000011,%11000011,%00001111,%11111111                    ' Tile color palette 0
              byte      %11110011,%00111111,%11001111,%11000011
              byte      %11010011,%00110111,%01001111,%01111011
              byte      %11010111,%01110111,%01011111,%00000011
t_palette1    byte      %00000011,%11110011,%11001111,%11000011                    ' Tile color palette 1
              byte      %00000011,%00110011,%11111111,%11000011
              byte      %00000011,%00110011,%11111111,%11000011
              byte      %00000011,%00110011,%11111111,%11000011

              long      0[120]

sprite_color_palettes
              ' Sprite color palettes
s_palette0    byte      %00000000,%00110011,%11000011,%11111111                    ' Tile color palette 0
              byte      %11110011,%00111111,%11001111,%11000011
              byte      %11010011,%00110111,%01001111,%01111011
              byte      %11010111,%01110111,%01011111,%00000011
s_palette1    byte      %00000000,%00110011,%11111111,%11000011                    ' Tile color palette 1
              byte      %00000011,%00110011,%11111111,%11000011
              byte      %00000011,%00110011,%11111111,%11000011
              byte      %00000011,%00110011,%11111111,%11000011

              long      0[120]

              ' Sprite attribute table
sprite_atts   long      0[NUM_SPRITES]

tile_maps
              ' Main tile map
tile_map0     word      $00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02                 ' row 0
              word      $00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03                 ' row 1
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 2
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 3
              word      $00_01,$00_02,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$00_01,$00_02                 ' row 4
              word      $00_04,$00_03,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$00_04,$00_03                 ' row 5
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 6
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 7
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 8
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 9
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 10
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$00_04,$00_03                 ' row 11
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$00_01,$00_02                 ' row 12
              word      $00_04,$00_03,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 13
              word      $00_01,$00_02,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 14
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 15
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 16
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 17
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 18
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 19
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 20
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 21
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 22
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 23
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 24
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_01,$01_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 25
              word      $00_01,$00_02,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_04,$01_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_01,$00_02                 ' row 26
              word      $00_04,$00_03,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$01_00,$00_04,$00_03                 ' row 27
              word      $00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02,$00_01,$00_02                 ' row 28
              word      $00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03,$00_04,$00_03                 ' row 29
